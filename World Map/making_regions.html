<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>
<script>
var regions_info = [{
region_name: "Europe",
countries: d3.set(['056', '442', '528', '008', '051', '031', '112', '070', '100', '191', '203', '233', '239', '348', '398', '417', '428', '440', '807', '498', '616', '642', '643', '688', '703', '705', '762', '795', '804', '860', '040', '276', '756', '250', '492', '540', '380', '674', '208', '246', '352', '578', '752', '196', '300', '376', '470', '620', '724', '372', '826'])
}
]

// var regions_info = [{
//         region_name: "AMERICAS",
//         countries: d3.set(['076', '188', '192', '214', '222', '320', '340', '558', '591', '484', '032', '152', '170', '218', '600', '604', '858', '862', '124'])
//     },

//     {
//         region_name: "APAC",
//         countries: d3.set(['036', '554', '116', '360', '418', '458', '104', '608', '702', '764', '704', '050', '064', '356', '524', '144', '410', '156', '344', '496', '392'])
//     },

//     {
//         region_name: "EMEA",
//         countries: d3.set(['056', '528', '008', '051', '031', '112', '070', '100', '191', '203', '233', '239', '348', '398', '417', '428', '440', '807', '616', '642', '643', '688', '703', '705', '762', '795', '804', '860', '040', '276', '756', '250', '492', '540', '380', '674', '208', '246', '352', '578', '752', '196', '300', '376', '470', '620', '724', '372', '024', '180', '288', '430', '450', '454', '508', '516', '566', '690', '694', '894', '716', '108', '232', '231', '404', '646', '706', '728', '800', '818', '004', '048', '364', '368', '400', '414', '422', '512', '586', '634', '682', '887', '012', '204', '854', '120', '140', '148', '384', '226', '266', '270', '324', '624', '434', '466', '478', '504', '562', '686', '768', '788', '426', '710', '748', '792'])
//     }
// ]

d3.queue()
    .defer(d3.json, 'test.geojson')
    .defer(d3.json, 'ISO Numeric.json')
    .await(merge);


function merge(error, countries_topo, iso_codes) {
    if (error) throw error;
    console.log('countries_topo', countries_topo)

    var regions_geo = [];
    for (var i = 0; i < regions_info.length; i++) {
        var countries = regions_info[i].countries;
        console.log(countries)

        countries_in_region = countries_topo.features.filter(function(d) {
            return countries.has(d.properties.id);
        })

        console.log('countries_in_region = ', countries_in_region)
        var region = topojson.merge(countries_topo, countries_in_region)
        console.log(region)

        regions_geo.push({
            'region_name': regions_info[i].region_name,
            'geo': region
        })
    }

    console.log(JSON.stringify(regions_geo))
}
</script>